'use strict';
var express = require('express');
var session = require('express-session');
const { exec } = require("child_process");
const {BabyJubPoint, Fr, randFr, G, keyGenRand, keyGen} = require("./BabyJubPoint");
var bodyParser = require('body-parser');
const MerkleTree = require('./merkle.js');
const Schnorr = require("./SchnorrSignature.js");
var cors = require('cors');
const fs = require('fs');
const path = require('path');
const mimcjs = require("./node_modules/circomlib/src/mimc7.js");
var Accounts = require('web3-eth-accounts');
const Web3 = require('web3');
const web3 = new Web3(new Web3.providers.HttpProvider("https://eth-kovan.alchemyapi.io/v2/TANKag2yF4E5MWYXyzlynLUZ21cEosP8"));

let accounts = new Accounts('wss://eth-kovan.ws.alchemyapi.io/v2/TANKag2yF4E5MWYXyzlynLUZ21cEosP8');
var app = express();
app.use(session({
	secret: 'secret',
	resave: true,
	saveUninitialized: true
}));
app.use(bodyParser.urlencoded({
	extended: true
}));
app.use(bodyParser.json());
app.engine('html', require('ejs').renderFile);

let abi = [
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "result",
				"type": "uint256"
			}
		],
		"name": "ElectionEnded",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "enum VoteContainer.VotingPhases",
				"name": "",
				"type": "uint8"
			}
		],
		"name": "NewElectionPhase",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "C",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "R",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "decryptorAddress",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "_decryptorPublicKey",
				"type": "uint256"
			}
		],
		"name": "addDecryptorPublicKey",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "bulletinBoardsAddress",
				"type": "address"
			}
		],
		"name": "addEligibleBulletinBoards",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_merkleRoot",
				"type": "uint256"
			}
		],
		"name": "addMerkleRoot",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "admin",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256[2]",
				"name": "a",
				"type": "uint256[2]"
			},
			{
				"internalType": "uint256[2][2]",
				"name": "b",
				"type": "uint256[2][2]"
			},
			{
				"internalType": "uint256[2]",
				"name": "c",
				"type": "uint256[2]"
			},
			{
				"internalType": "uint256",
				"name": "prevRoot",
				"type": "uint256"
			},
			{
				"internalType": "uint256[2]",
				"name": "prevVoteR",
				"type": "uint256[2]"
			},
			{
				"internalType": "uint256[2]",
				"name": "prevVoteC",
				"type": "uint256[2]"
			},
			{
				"internalType": "uint256",
				"name": "nextRoot",
				"type": "uint256"
			},
			{
				"internalType": "uint256[2]",
				"name": "newVoteR",
				"type": "uint256[2]"
			},
			{
				"internalType": "uint256[2]",
				"name": "newVoteC",
				"type": "uint256[2]"
			}
		],
		"name": "castVote",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "decryptorPublicKey",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "endRegistration",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "endVoteCasting",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "key",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "merkleRoot",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "votingResult",
				"type": "uint256"
			}
		],
		"name": "revealVotingResult",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256[2]",
				"name": "a",
				"type": "uint256[2]"
			},
			{
				"internalType": "uint256[2][2]",
				"name": "b",
				"type": "uint256[2][2]"
			},
			{
				"internalType": "uint256[2]",
				"name": "c",
				"type": "uint256[2]"
			},
			{
				"internalType": "uint256",
				"name": "sRComressed",
				"type": "uint256"
			}
		],
		"name": "voteDecrypt",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	}
];
// The bytecode from Solidity, compiling the above source
let bytecode = "0x60806040523480156200001157600080fd5b5033600a60006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506040518060800160405280600081526020016001815260200160008152602001600181525060049060046200008a9291906200010a565b5060405180604001604052806000815260200160018152506000906002620000b49291906200014f565b5060405180604001604052806000815260200160018152506002906002620000de9291906200014f565b506000600d60016101000a81548160ff02191690836003811115620000ff57fe5b0217905550620001bc565b82600481019282156200013c579160200282015b828111156200013b5782518255916020019190600101906200011e565b5b5090506200014b919062000194565b5090565b826002810192821562000181579160200282015b828111156200018057825182559160200191906001019062000163565b5b50905062000190919062000194565b5090565b620001b991905b80821115620001b55760008160009055506001016200019b565b5090565b90565b6158e480620001cc6000396000f3fe608060405234801561001057600080fd5b50600436106100ea5760003560e01c80637309fa2c1161008c578063bdb5001311610066578063bdb50013146105c1578063e5cfd849146105ef578063ec6d1b2514610631578063f851a4401461067f576100ea565b80637309fa2c14610531578063913b69661461055f578063bbc73fe9146105b7576100ea565b806348747a14116100c857806348747a14146103635780634a8a62ab1461048d578063603506fc146104ab5780636e9ed8cf146104ef576100ea565b80632eb4a7ab146100ef5780632fa35f781461010d5780633943380c14610345575b600080fd5b6100f76106c9565b6040518082815260200191505060405180910390f35b610343600480360361024081101561012457600080fd5b8101908080604001906002806020026040519081016040528092919082600260200280828437600081840152601f19601f82011690508083019250505050505091929192908060800190600280602002604051908101604052809291906000905b828210156101d9578382604002016002806020026040519081016040528092919082600260200280828437600081840152601f19601f82011690508083019250505050505081526020019060010190610185565b50505050919291929080604001906002806020026040519081016040528092919082600260200280828437600081840152601f19601f82011690508083019250505050505091929192908035906020019092919080604001906002806020026040519081016040528092919082600260200280828437600081840152601f19601f820116905080830192505050505050919291929080604001906002806020026040519081016040528092919082600260200280828437600081840152601f19601f82011690508083019250505050505091929192908035906020019092919080604001906002806020026040519081016040528092919082600260200280828437600081840152601f19601f820116905080830192505050505050919291929080604001906002806020026040519081016040528092919082600260200280828437600081840152601f19601f82011690508083019250505050505091929192905050506106cf565b005b61034d610da4565b6040518082815260200191505060405180910390f35b61048b600480360361012081101561037a57600080fd5b8101908080604001906002806020026040519081016040528092919082600260200280828437600081840152601f19601f82011690508083019250505050505091929192908060800190600280602002604051908101604052809291906000905b8282101561042f578382604002016002806020026040519081016040528092919082600260200280828437600081840152601f19601f820116905080830192505050505050815260200190600101906103db565b50505050919291929080604001906002806020026040519081016040528092919082600260200280828437600081840152601f19601f820116905080830192505050505050919291929080359060200190929190505050610daa565b005b61049561136b565b6040518082815260200191505060405180910390f35b6104ed600480360360208110156104c157600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff16906020019092919050505061156b565b005b61051b6004803603602081101561050557600080fd5b81019080803590602001909291905050506117ce565b6040518082815260200191505060405180910390f35b61055d6004803603602081101561054757600080fd5b81019080803590602001909291905050506117e6565b005b6105a16004803603602081101561057557600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050611931565b6040518082815260200191505060405180910390f35b6105bf611949565b005b6105ed600480360360208110156105d757600080fd5b8101908080359060200190929190505050611af6565b005b61061b6004803603602081101561060557600080fd5b8101908080359060200190929190505050611ce7565b6040518082815260200191505060405180910390f35b61067d6004803603604081101561064757600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff16906020019092919080359060200190929190505050611cff565b005b610687611f19565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b60095481565b600b60003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff16610771576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260268152602001806158896026913960400191505060405180910390fd5b6001600381111561077e57fe5b600d60019054906101000a900460ff16600381111561079957fe5b1461080c576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601a8152602001807f4e6f7420696e20766f74652063617374696e672070686173652e00000000000081525060200191505060405180910390fd5b8460006002811061081957fe5b60200201516000806002811061082b57fe5b015414801561085957508460016002811061084257fe5b6020020151600060016002811061085557fe5b0154145b6108cb576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260168152602001807f50726576696f757320522069736e277420657175616c0000000000000000000081525060200191505060405180910390fd5b836000600281106108d857fe5b602002015160026000600281106108eb57fe5b015414801561091957508360016002811061090257fe5b6020020151600260016002811061091557fe5b0154145b61098b576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260168152602001807f50726576696f757320522069736e277420657175616c0000000000000000000081525060200191505060405180910390fd5b8560095414610a02576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260208152602001807f50726576696f7573206d65726b6c6520726f6f742069736e277420657175616c81525060200191505060405180910390fd5b610a0a612eb3565b610a4f60048080602002604051908101604052809291908260048015610a45576020028201915b815481526020019060010190808311610a31575b5050505050611f3f565b9050610a59612ed5565b604051806101a0016040528089815260200188600060028110610a7857fe5b6020020151815260200188600160028110610a8f57fe5b6020020151815260200187600060028110610aa657fe5b6020020151815260200187600160028110610abd57fe5b6020020151815260200186815260200185600060028110610ada57fe5b6020020151815260200185600160028110610af157fe5b6020020151815260200184600060028110610b0857fe5b6020020151815260200184600160028110610b1f57fe5b6020020151815260200183600060028110610b3657fe5b6020020151815260200183600160028110610b4d57fe5b60200201518152602001600181525090506000604051610b6c90612ef8565b604051809103906000f080158015610b88573d6000803e3d6000fd5b509050600115158173ffffffffffffffffffffffffffffffffffffffff1663f057b14e8e8e8e876040518563ffffffff1660e01b81526004018085600260200280838360005b83811015610be9578082015181840152602081019050610bce565b505050509050018460026000925b81841015610c3d5782846020020151600260200280838360005b83811015610c2c578082015181840152602081019050610c11565b505050509050019260010192610bf7565b9250505083600260200280838360005b83811015610c68578082015181840152602081019050610c4d565b5050505090500182600d60200280838360005b83811015610c96578082015181840152602081019050610c7b565b5050505090500194505050505060206040518083038186803b158015610cbb57600080fd5b505afa158015610ccf573d6000803e3d6000fd5b505050506040513d6020811015610ce557600080fd5b8101908080519060200190929190505050151514610d6b576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260138152602001807f50726f6f66206973206e6f742076616c6964210000000000000000000000000081525060200191505060405180910390fd5b846000906002610d7c929190612f05565b50836002906002610d8e929190612f05565b5085600981905550505050505050505050505050565b60085481565b6000600c60003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020541415610e60576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601a8152602001807f4e6f7420616e20656c696769626c6520646563727970746f722e00000000000081525060200191505060405180910390fd5b60026003811115610e6d57fe5b600d60019054906101000a900460ff166003811115610e8857fe5b14610efb576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260198152602001807f4e6f7420696e2064656372797074696f6e20706572696f642e0000000000000081525060200191505060405180910390fd5b610f03612eb3565b610f4b600c60003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205461200f565b9050610f55612eb3565b610f5e8361200f565b9050610f68612f45565b6040518060e0016040528084600060028110610f8057fe5b6020020151815260200184600160028110610f9757fe5b6020020151815260200160008060028110610fae57fe5b015481526020016000600160028110610fc357fe5b0154815260200183600060028110610fd757fe5b6020020151815260200183600160028110610fee57fe5b6020020151815260200160018152509050600060405161100d90612f67565b604051809103906000f080158015611029573d6000803e3d6000fd5b509050600115158173ffffffffffffffffffffffffffffffffffffffff166346d8653f8a8a8a876040518563ffffffff1660e01b81526004018085600260200280838360005b8381101561108a57808201518184015260208101905061106f565b505050509050018460026000925b818410156110de5782846020020151600260200280838360005b838110156110cd5780820151818401526020810190506110b2565b505050509050019260010192611098565b9250505083600260200280838360005b838110156111095780820151818401526020810190506110ee565b5050505090500182600760200280838360005b8381101561113757808201518184015260208101905061111c565b5050505090500194505050505060206040518083038186803b15801561115c57600080fd5b505afa158015611170573d6000803e3d6000fd5b505050506040513d602081101561118657600080fd5b810190808051906020019092919050505015151461120c576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260168152602001807f4e6f7420612076616c69642064656372797074696f6e0000000000000000000081525060200191505060405180910390fd5b61125260028080602002604051908101604052809291908260028015611247576020028201915b815481526020019060010190808311611233575b5050505050846121af565b6002906002611262929190612f05565b50600d600081819054906101000a900460ff16809291906001900391906101000a81548160ff021916908360ff160217905550506000600d60009054906101000a900460ff1660ff16141561131c576003600d60016101000a81548160ff021916908360038111156112d057fe5b02179055507f68c8c6cfdefb03fbc9325bd0d111232bc413157d09741f1838286c1eb439a14660036040518082600381111561130857fe5b60ff16815260200191505060405180910390a15b505050506000600c60003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000208190555050505050565b6000600a60009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614611413576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260298152602001806158606029913960400191505060405180910390fd5b6000600381111561142057fe5b600d60019054906101000a900460ff16600381111561143b57fe5b146114ae576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601b8152602001807f526567697274726174696f6e207068617365206973206f7665722e000000000081525060200191505060405180910390fd5b6001600d60016101000a81548160ff021916908360038111156114cd57fe5b02179055507f68c8c6cfdefb03fbc9325bd0d111232bc413157d09741f1838286c1eb439a14660016040518082600381111561150557fe5b60ff16815260200191505060405180910390a161155d60048080602002604051908101604052809291908260048015611553576020028201915b81548152602001906001019080831161153f575b50505050506121d1565b600881905550600854905090565b600a60009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614611611576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260298152602001806158606029913960400191505060405180910390fd5b6000600381111561161e57fe5b600d60019054906101000a900460ff16600381111561163957fe5b146116ac576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601b8152602001807f526567697274726174696f6e207068617365206973206f7665722e000000000081525060200191505060405180910390fd5b60011515600b60008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff1615151415611773576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260208152602001807f446f6e7420616c6c6f7720616464206f6e65206164647265737320747769636581525060200191505060405180910390fd5b6001600b60008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff02191690831515021790555050565b600281600281106117db57fe5b016000915090505481565b600a60009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161461188c576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260298152602001806158606029913960400191505060405180910390fd5b6000600381111561189957fe5b600d60019054906101000a900460ff1660038111156118b457fe5b14611927576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601b8152602001807f526567697274726174696f6e207068617365206973206f7665722e000000000081525060200191505060405180910390fd5b8060098190555050565b600c6020528060005260406000206000915090505481565b600a60009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16146119ef576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260298152602001806158606029913960400191505060405180910390fd5b600160038111156119fc57fe5b600d60019054906101000a900460ff166003811115611a1757fe5b14611a8a576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601a8152602001807f4e6f7420696e20766f74652063617374696e672070686173652e00000000000081525060200191505060405180910390fd5b6002600d60016101000a81548160ff02191690836003811115611aa957fe5b02179055507f68c8c6cfdefb03fbc9325bd0d111232bc413157d09741f1838286c1eb439a146600260405180826003811115611ae157fe5b60ff16815260200191505060405180910390a1565b600a60009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614611b9c576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260298152602001806158606029913960400191505060405180910390fd5b600380811115611ba857fe5b600d60019054906101000a900460ff166003811115611bc357fe5b14611c36576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601f8152602001807f44656372797074696f6e206973206e6f742066696e6973686564207965742e0081525060200191505060405180910390fd5b611c7b60028080602002604051908101604052809291908260028015611c71576020028201915b815481526020019060010190808311611c5d575b50505050506122fd565b611c8c611c8661238d565b836123b5565b14611c9657600080fd5b7f562cd572b2ba3b666cd989fc4ca98419ec81e75f04528df9d9d76fdb7807ee71816040518082815260200191505060405180910390a1600073ffffffffffffffffffffffffffffffffffffffff16ff5b60008160028110611cf457fe5b016000915090505481565b600a60009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614611da5576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260298152602001806158606029913960400191505060405180910390fd5b60006003811115611db257fe5b600d60019054906101000a900460ff166003811115611dcd57fe5b14611e40576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601b8152602001807f526567697274726174696f6e207068617365206973206f7665722e000000000081525060200191505060405180910390fd5b80600c60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550611ed260048080602002604051908101604052809291908260048015611ebf576020028201915b815481526020019060010190808311611eab575b5050505050611ecd836123d9565b6125b0565b6004906004611ee2929190612f74565b50600d600081819054906101000a900460ff168092919060010191906101000a81548160ff021916908360ff160217905550505050565b600a60009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b611f47612eb3565b6000611f6383600360048110611f5957fe5b60200201516126bf565b90507f30644e72e131a029b85045b68181585d2833e84879b9709143e1f593f000000180611f8d57fe5b8184600060048110611f9b57fe5b60200201510982600060028110611fae57fe5b6020020181815250507f30644e72e131a029b85045b68181585d2833e84879b9709143e1f593f000000180611fdf57fe5b8184600160048110611fed57fe5b6020020151098260016002811061200057fe5b60200201818152505050919050565b612017612eb3565b6000807f800000000000000000000000000000000000000000000000000000000000000084161415905060007f7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8416905060007f30644e72e131a029b85045b68181585d2833e84879b9709143e1f593f00000018061209257fe5b828309905060007f30644e72e131a029b85045b68181585d2833e84879b9709143e1f593f0000001806120c157fe5b6121036120fe620292fc7f30644e72e131a029b85045b68181585d2833e84879b9709143e1f593f0000001806120f357fe5b86620292f8096126f2565b6126bf565b61210e6001856126f2565b099050600061211c82612749565b905060007f183227397098d014dc2822db40c0ac2e9419f4243cdcb848a1f0fac9f800000082119050858015612150575080155b806121625750851580156121615750805b5b1561218d57817f30644e72e131a029b85045b68181585d2833e84879b9709143e1f593f00000010391505b6040518060400160405280838152602001868152509650505050505050919050565b6121b7612eb3565b6121c9836121c484612929565b612991565b905092915050565b6000806121ee836003600481106121e457fe5b60200201516126bf565b90507f183227397098d014dc2822db40c0ac2e9419f4243cdcb848a1f0fac9f80000007f30644e72e131a029b85045b68181585d2833e84879b9709143e1f593f00000018061223957fe5b828560006004811061224757fe5b60200201510911156122b8577f80000000000000000000000000000000000000000000000000000000000000007f30644e72e131a029b85045b68181585d2833e84879b9709143e1f593f00000018061229c57fe5b82856001600481106122aa57fe5b6020020151091791506122f7565b7f30644e72e131a029b85045b68181585d2833e84879b9709143e1f593f0000001806122e057fe5b81846001600481106122ee57fe5b60200201510991505b50919050565b60007f183227397098d014dc2822db40c0ac2e9419f4243cdcb848a1f0fac9f80000008260006002811061232d57fe5b60200201511115612373577f80000000000000000000000000000000000000000000000000000000000000008260016002811061236657fe5b6020020151179050612388565b8160016002811061238057fe5b602002015190505b919050565b60007fae07297f8d3c3d7818dbddfd24c35583f9a9d4ed0cb0c1d1348dd8f7f99152d7905090565b60006123d16123cc6123c6856123d9565b84612c54565b6121d1565b905092915050565b6123e1612fb4565b6000807f800000000000000000000000000000000000000000000000000000000000000084161415905060007f7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8416905060007f30644e72e131a029b85045b68181585d2833e84879b9709143e1f593f00000018061245c57fe5b828309905060007f30644e72e131a029b85045b68181585d2833e84879b9709143e1f593f00000018061248b57fe5b6124cd6124c8620292fc7f30644e72e131a029b85045b68181585d2833e84879b9709143e1f593f0000001806124bd57fe5b86620292f8096126f2565b6126bf565b6124d86001856126f2565b09905060006124e682612749565b905060007f183227397098d014dc2822db40c0ac2e9419f4243cdcb848a1f0fac9f80000008211905085801561251a575080155b8061252c57508515801561252b5750805b5b1561255757817f30644e72e131a029b85045b68181585d2833e84879b9709143e1f593f00000010391505b60405180608001604052808381526020018681526020017f30644e72e131a029b85045b68181585d2833e84879b9709143e1f593f00000018061259657fe5b878509815260200160018152509650505050505050919050565b6125b8612fb4565b7f30644e72e131a029b85045b68181585d2833e84879b9709143e1f593f0000001620292fc620292f88285518751098360208701516020890151098460408801518660408b015186090985606089015160608b015109868760208b01518b51088860208d01518d510809600185018110156126335787810190505b878582030690506001840181101561264b5787810190505b8784820306905081600184018110156126645788810190505b888482030690508884840889878a098660018201811015612685578b810190505b8b8282030690508b8486098d528b81840960208e01528b81860960408e01528b83850960608e015250505050505050505050505092915050565b60006126eb827f30644e72e131a029b85045b68181585d2833e84879b9709143e1f593efffffff612d65565b9050919050565b60007f30644e72e131a029b85045b68181585d2833e84879b9709143e1f593f00000018061271c57fe5b827f30644e72e131a029b85045b68181585d2833e84879b9709143e1f593f0000001038408905092915050565b6000612772827c0183227397098d014dc2822db40c0ac2e9419f4243cdcb848a1f0faca0612d65565b9050600061279d837c030644e72e131a029b85045b68181585d2833e84879b9709143e1f593f612d65565b905060007f2a3c09f0a58a7e8500e0a7eb8ef62abc402d111e41112ed49bd61b6e725b19f09050600080601c905060005b60011561291e57600090508492505b6001831461281f577f30644e72e131a029b85045b68181585d2833e84879b9709143e1f593f00000018061280d57fe5b838409925080806001019150506127dd565b60008161ffff161415612839578595505050505050612924565b83925060005b60018284030361ffff168161ffff16101561288e577f30644e72e131a029b85045b68181585d2833e84879b9709143e1f593f00000018061287c57fe5b8485099350808060010191505061283f565b507f30644e72e131a029b85045b68181585d2833e84879b9709143e1f593f0000001806128b757fe5b83840993507f30644e72e131a029b85045b68181585d2833e84879b9709143e1f593f0000001806128e457fe5b86840995507f30644e72e131a029b85045b68181585d2833e84879b9709143e1f593f00000018061291157fe5b84860994508091506127ce565b50505050505b919050565b612931612eb3565b60405180604001604052808360006002811061294957fe5b60200201517f30644e72e131a029b85045b68181585d2833e84879b9709143e1f593f00000010381526020018360016002811061298257fe5b60200201518152509050919050565b612999612eb3565b60007f30644e72e131a029b85045b68181585d2833e84879b9709143e1f593f0000001806129c357fe5b836000600281106129d057fe5b6020020151856000600281106129e257fe5b602002015109905060007f30644e72e131a029b85045b68181585d2833e84879b9709143e1f593f000000180612a1457fe5b84600160028110612a2157fe5b602002015186600160028110612a3357fe5b602002015109905060007f30644e72e131a029b85045b68181585d2833e84879b9709143e1f593f000000180612a6557fe5b7f30644e72e131a029b85045b68181585d2833e84879b9709143e1f593f000000180612a8d57fe5b838509620292f809905060007f30644e72e131a029b85045b68181585d2833e84879b9709143e1f593f000000180612ac157fe5b7f30644e72e131a029b85045b68181585d2833e84879b9709143e1f593f000000180612ae957fe5b87600060028110612af657fe5b602002015189600160028110612b0857fe5b6020020151097f30644e72e131a029b85045b68181585d2833e84879b9709143e1f593f000000180612b3657fe5b88600160028110612b4357fe5b60200201518a600060028110612b5557fe5b6020020151090890506000612b97847f30644e72e131a029b85045b68181585d2833e84879b9709143e1f593f000000180612b8c57fe5b87620292fc096126f2565b905060405180604001604052807f30644e72e131a029b85045b68181585d2833e84879b9709143e1f593f000000180612bcc57fe5b612c007f30644e72e131a029b85045b68181585d2833e84879b9709143e1f593f000000180612bf757fe5b876001086126bf565b850981526020017f30644e72e131a029b85045b68181585d2833e84879b9709143e1f593f000000180612c2f57fe5b612c42612c3d6001886126f2565b6126bf565b84098152509550505050505092915050565b612c5c612fb4565b6000829050612c69612fb4565b604051806080016040528060008152602001600181526020016000815260200160018152509050600085600060048110612c9f57fe5b60200201519050600086600160048110612cb557fe5b60200201519050600087600260048110612ccb57fe5b60200201519050600088600360048110612ce157fe5b602002015190505b60008614612d565760006001871614612d2957612d26856040518060800160405280878152602001868152602001858152602001848152506125b0565b94505b612d34848483612dd9565b8094508195508296508397505050505060028681612d4e57fe5b049550612ce9565b84965050505050505092915050565b60007f30644e72e131a029b85045b68181585d2833e84879b9709143e1f593f000000160405160208152602080820152602060408201528460608201528360808201528160a082015260208160c08360055afa8060008114612dca5782519450612dcf565b600080fd5b5050505092915050565b6000806000807f30644e72e131a029b85045b68181585d2833e84879b9709143e1f593f0000001620292fc81898a0982898a098389858b6002090984838509858c8e0886818209905060018501811015612e335786810190505b8685820306905060018401811015612e4b5786810190505b86848203069050868483088060018501811015612e685788810190505b888582030690508360018701811015612e815789810190505b89878203069050898285099d50898184099c50898185099b50898383099a505050505050505050505093509350935093565b6040518060400160405280600290602082028038833980820191505090505090565b604051806101a00160405280600d90602082028038833980820191505090505090565b61158580612ffc83390190565b8260028101928215612f34579160200282015b82811115612f33578251825591602001919060010190612f18565b5b509050612f419190612fd6565b5090565b6040518060e00160405280600790602082028038833980820191505090505090565b6112df8061458183390190565b8260048101928215612fa3579160200282015b82811115612fa2578251825591602001919060010190612f87565b5b509050612fb09190612fd6565b5090565b6040518060800160405280600490602082028038833980820191505090505090565b612ff891905b80821115612ff4576000816000905550600101612fdc565b5090565b9056fe608060405234801561001057600080fd5b50611565806100206000396000f3fe608060405234801561001057600080fd5b506004361061002b5760003560e01c8063f057b14e14610030575b600080fd5b61019060048036036102a081101561004757600080fd5b8101908080604001906002806020026040519081016040528092919082600260200280828437600081840152601f19601f82011690508083019250505050505091929192908060800190600280602002604051908101604052809291906000905b828210156100fc578382604002016002806020026040519081016040528092919082600260200280828437600081840152601f19601f820116905080830192505050505050815260200190600101906100a8565b50505050919291929080604001906002806020026040519081016040528092919082600260200280828437600081840152601f19601f8201169050808301925050505050509192919290806101a00190600d806020026040519081016040528092919082600d60200280828437600081840152601f19601f82011690508083019250505050505091929192905050506101aa565b604051808215151515815260200191505060405180910390f35b60006101b46113d3565b6040518060400160405280876000600281106101cc57fe5b60200201518152602001876001600281106101e357fe5b60200201518152508160000181905250604051806040016040528060405180604001604052808860006002811061021657fe5b602002015160006002811061022757fe5b602002015181526020018860006002811061023e57fe5b602002015160016002811061024f57fe5b6020020151815250815260200160405180604001604052808860016002811061027457fe5b602002015160006002811061028557fe5b602002015181526020018860016002811061029c57fe5b60200201516001600281106102ad57fe5b602002015181525081525081602001819052506040518060400160405280856000600281106102d857fe5b60200201518152602001856001600281106102ef57fe5b602002015181525081604001819052506060600d6040519080825280602002602001820160405280156103315781602001602082028038833980820191505090505b50905060008090505b600d811015610379578481600d811061034f57fe5b602002015182828151811061036057fe5b602002602001018181525050808060010191505061033a565b50600061038682846103a6565b14156103975760019250505061039e565b6000925050505b949350505050565b6000807f30644e72e131a029b85045b68181585d2833e84879b9709143e1f593f000000190506103d4611406565b6103dc610518565b90508060800151516001865101146103f357600080fd5b6103fb61144d565b6040518060400160405280600081526020016000815250905060008090505b8651811015610491578387828151811061043057fe5b60200260200101511061044257600080fd5b6104828261047d8560800151600185018151811061045c57fe5b60200260200101518a858151811061047057fe5b6020026020010151610e3f565b610ed1565b9150808060010191505061041a565b506104b48183608001516000815181106104a757fe5b6020026020010151610ed1565b90506104fa856000015186602001516104cc84610f82565b85604001516104de8a60400151610f82565b87606001516104f08960000151610f82565b896020015161101c565b61050a5760019350505050610512565b600093505050505b92915050565b610520611406565b60405180604001604052807f14fad556c9b5158acb032bd0b19b79e216fd73482a87e1eb3aa83c9730d6fb7a81526020017e37a89c798f6f6e36bec749a443a799c19807d747a0a711314d913abe45bc898152508160000181905250604051806040016040528060405180604001604052807f0c14375e8c0268c76694f0ae804c672e605d80c44a0907eb3402179779d4f70181526020017f30133055ce3979b03a62c051a907650de102b04a524b11a0dfd825270f4b7390815250815260200160405180604001604052807f02b226513396a9e34fcc008bf349e0c0c5469c0f500f23b51677a865d5a15d2781526020017f19fb581ce0224278e0c0a819a0e221293f287d55d9f8b6d53866c71304641fad8152508152508160200181905250604051806040016040528060405180604001604052807f2908a64cf1f4e076f49be7f3a45765f284ced364bf9aa428a34e11ef9d7cfbc381526020017f1522fe3132b18726bc88069ca0b6046022acc5dcb679eedf4c9bf2637d4d51a6815250815260200160405180604001604052807f2103262312f9feb1a94703ad585d1c83159c0d8b5190145b488bd9f9c4a65ba081526020017f1dcd29ae5617d5c2e7d23c68c0defa2722719d6a9b90b7077c83fbd6426490838152508152508160400181905250604051806040016040528060405180604001604052807f09207c80b9a0786614eae4bed2791eb7c4e9f8a851a49cc78abfeffc1221f92c81526020017f28b5bd2375f1b60a0d12d98134ea1dd258e97b3631570ad0819d6fd3f16aa4a4815250815260200160405180604001604052807f262291472c37218a533fe9a983e6df3437bbefcf462bbc6423132504e7e1ba3181526020017f261bb9cb2ae41b494c7754db8cf3ecfd7f1bd8bdc83b0045ff5f47defe90be3b8152508152508160600181905250600e60405190808252806020026020018201604052801561080657816020015b6107f3611467565b8152602001906001900390816107eb5790505b50816080018190525060405180604001604052807f2fbe1e6cd513b403f0bf6590d628e63e029f9b173d530e3719b6efade80d0dcc81526020017f03b9f257f6e6545265384934e52bfea43ea99d3c387a35bcf8e7c31a1faf5e5e815250816080015160008151811061087557fe5b602002602001018190525060405180604001604052807f2ce86a6fc592680bd82782e32686fa96a63dc2d8cd66d3aee1ee7982326b42e181526020017f074288bf71e0274f2c8b4231b775e95a2b5e673a0bf94cefd6c59344404ee0c381525081608001516001815181106108e657fe5b602002602001018190525060405180604001604052807f213e60022df13e29cac4c0e4151b95e1d86c0282dd7d7215abd654c08a3e496181526020017f195a698c07bc40df463481556abca3d9e47450c81506b0f1891c391da4c71edd815250816080015160028151811061095757fe5b602002602001018190525060405180604001604052807f2a80f4e6e288989de56a516acbc7465c0848ec5d77f2c39616d4ab9cbaee089a81526020017f04466e7aceaf9be163633e6126bb079b15c06f0e18b96969ddd8163dcfefc81181525081608001516003815181106109c857fe5b602002602001018190525060405180604001604052807f192f490950fc36c30cb1e9000491f101ae94351211a02a36f0e3c44a0623163581526020017f0a311e45f05feb865deaf36612778cacef3c76bd66db92d1df30b350ba9753548152508160800151600481518110610a3957fe5b602002602001018190525060405180604001604052807f0720c01d9417e6528b7eb5e9b8a25b3e4d6beb69f9836ddfcece845c1c552d5881526020017f0d27fe5d812641bd005da39fffa4f890d5d6bac8167ad9ba7c54a7e268f85c518152508160800151600581518110610aaa57fe5b602002602001018190525060405180604001604052807f2e920ff7f44c3f6d18d82a9efa2babf2dc9640fce905e2f5e5163817ae80537d81526020017e61b17decd845c9cab118a70f6464f201c77be89ebd39decdb3a179a7a450488152508160800151600681518110610b1a57fe5b602002602001018190525060405180604001604052807f28bf68ddbcab87f9f0852fd7d3e41fc2f09898168d74d8bf1dcad8b00f9da04c81526020017f0e330cd5307cc205ab8ef3d48dbcdb2eb78fef3fac5d6585afe7d484f364f9c68152508160800151600781518110610b8b57fe5b602002602001018190525060405180604001604052807f0d365a9a56a430aaeb898fb2a222d627e25fd42833ca792660d881b611c9f2d581526020017f18c0388b04d6ecc4d7b7e364038132da00b3efc5a3bec420b4ee750a923714328152508160800151600881518110610bfc57fe5b602002602001018190525060405180604001604052807f022c6e101100bab817e31793f206d274b0afd53ff2b303ebd9ed0f05c7270c3881526020017f279676ff67d366bb922767d29f2196a10c1bedc08a9c288bb8b54ea8e8f7897b8152508160800151600981518110610c6d57fe5b602002602001018190525060405180604001604052807f04941cb3456ec685dafc8f59af6443a6e00a6450706e10772891e62bffdda22d81526020017f0988956fd7ea7f5ef8698d69a343a6c817d6293c42f7b2aebd1e8ee976c2d88f8152508160800151600a81518110610cde57fe5b602002602001018190525060405180604001604052807f29c23c3fb9184238910bcf602d14b2af02e46ff98018026f8db163d85f66493081526020017f2117bb268141e3a7021e1c02c0ab47447f7c954ab7dda0e7264061627c1820d18152508160800151600b81518110610d4f57fe5b602002602001018190525060405180604001604052807f035ce42e00f61abfe1eab532a701b1de9fd9d275c0ce5fdccf577bff50b2260381526020017f19c01d1c9369a69e568e5d906e008380fc61689800c183838b28a56b6f95af3b8152508160800151600c81518110610dc057fe5b602002602001018190525060405180604001604052807f2442296ceeaa9314dfc0864750c08b0d321b856d62bf54cc637136572138e8b081526020017f04b225e4d0a832924b1778fed8670ea1df1d77eaf166a263be6d4d6f8d4665a38152508160800151600d81518110610e3157fe5b602002602001018190525090565b610e4761144d565b610e4f611481565b836000015181600060038110610e6157fe5b602002018181525050836020015181600160038110610e7c57fe5b6020020181815250508281600260038110610e9357fe5b602002018181525050600060608360808460076107d05a03fa90508060008114610ebc57610ebe565bfe5b5080610ec957600080fd5b505092915050565b610ed961144d565b610ee16114a3565b836000015181600060048110610ef357fe5b602002018181525050836020015181600160048110610f0e57fe5b602002018181525050826000015181600260048110610f2957fe5b602002018181525050826020015181600360048110610f4457fe5b602002018181525050600060608360c08460066107d05a03fa90508060008114610f6d57610f6f565bfe5b5080610f7a57600080fd5b505092915050565b610f8a61144d565b60007f30644e72e131a029b85045b68181585d97816a916871ca8d3c208c16d87cfd47905060008360000151148015610fc7575060008360200151145b15610feb576040518060400160405280600081526020016000815250915050611017565b6040518060400160405280846000015181526020018285602001518161100d57fe5b0683038152509150505b919050565b60006060600460405190808252806020026020018201604052801561105b57816020015b611048611467565b8152602001906001900390816110405790505b5090506060600460405190808252806020026020018201604052801561109b57816020015b6110886114c5565b8152602001906001900390816110805790505b5090508a826000815181106110ac57fe5b602002602001018190525088826001815181106110c557fe5b602002602001018190525086826002815181106110de57fe5b602002602001018190525084826003815181106110f757fe5b6020026020010181905250898160008151811061111057fe5b6020026020010181905250878160018151811061112957fe5b6020026020010181905250858160028151811061114257fe5b6020026020010181905250838160038151811061115b57fe5b60200260200101819052506111708282611180565b9250505098975050505050505050565b6000815183511461119057600080fd5b60008351905060006006820290506060816040519080825280602002602001820160405280156111cf5781602001602082028038833980820191505090505b50905060008090505b83811015611375578681815181106111ec57fe5b60200260200101516000015182600060068402018151811061120a57fe5b60200260200101818152505086818151811061122257fe5b60200260200101516020015182600160068402018151811061124057fe5b60200260200101818152505085818151811061125857fe5b60200260200101516000015160016002811061127057fe5b602002015182600260068402018151811061128757fe5b60200260200101818152505085818151811061129f57fe5b6020026020010151600001516000600281106112b757fe5b60200201518260036006840201815181106112ce57fe5b6020026020010181815250508581815181106112e657fe5b6020026020010151602001516001600281106112fe57fe5b602002015182600460068402018151811061131557fe5b60200260200101818152505085818151811061132d57fe5b60200260200101516020015160006002811061134557fe5b602002015182600560068402018151811061135c57fe5b60200260200101818152505080806001019150506111d8565b5061137e6114eb565b6000602082602086026020860160086107d05a03fa905080600081146113a3576113a5565bfe5b50806113b057600080fd5b6000826000600181106113bf57fe5b602002015114159550505050505092915050565b60405180606001604052806113e6611467565b81526020016113f36114c5565b8152602001611400611467565b81525090565b6040518060a00160405280611419611467565b81526020016114266114c5565b81526020016114336114c5565b81526020016114406114c5565b8152602001606081525090565b604051806040016040528060008152602001600081525090565b604051806040016040528060008152602001600081525090565b6040518060600160405280600390602082028038833980820191505090505090565b6040518060800160405280600490602082028038833980820191505090505090565b60405180604001604052806114d861150d565b81526020016114e561150d565b81525090565b6040518060200160405280600190602082028038833980820191505090505090565b604051806040016040528060029060208202803883398082019150509050509056fea2646970667358221220ceebfa26d691ccf350985238e7dc82ce76ae2eb1ee4f552220191536335c341d64736f6c63430006010033608060405234801561001057600080fd5b506112bf806100206000396000f3fe608060405234801561001057600080fd5b506004361061002b5760003560e01c806346d8653f14610030575b600080fd5b61018f60048036036101e081101561004757600080fd5b8101908080604001906002806020026040519081016040528092919082600260200280828437600081840152601f19601f82011690508083019250505050505091929192908060800190600280602002604051908101604052809291906000905b828210156100fc578382604002016002806020026040519081016040528092919082600260200280828437600081840152601f19601f820116905080830192505050505050815260200190600101906100a8565b50505050919291929080604001906002806020026040519081016040528092919082600260200280828437600081840152601f19601f82011690508083019250505050505091929192908060e001906007806020026040519081016040528092919082600760200280828437600081840152601f19601f82011690508083019250505050505091929192905050506101a9565b604051808215151515815260200191505060405180910390f35b60006101b361112d565b6040518060400160405280876000600281106101cb57fe5b60200201518152602001876001600281106101e257fe5b60200201518152508160000181905250604051806040016040528060405180604001604052808860006002811061021557fe5b602002015160006002811061022657fe5b602002015181526020018860006002811061023d57fe5b602002015160016002811061024e57fe5b6020020151815250815260200160405180604001604052808860016002811061027357fe5b602002015160006002811061028457fe5b602002015181526020018860016002811061029b57fe5b60200201516001600281106102ac57fe5b602002015181525081525081602001819052506040518060400160405280856000600281106102d757fe5b60200201518152602001856001600281106102ee57fe5b60200201518152508160400181905250606060076040519080825280602002602001820160405280156103305781602001602082028038833980820191505090505b50905060008090505b60078110156103785784816007811061034e57fe5b602002015182828151811061035f57fe5b6020026020010181815250508080600101915050610339565b50600061038582846103a5565b14156103965760019250505061039d565b6000925050505b949350505050565b6000807f30644e72e131a029b85045b68181585d2833e84879b9709143e1f593f000000190506103d3611160565b6103db610517565b90508060800151516001865101146103f257600080fd5b6103fa6111a7565b6040518060400160405280600081526020016000815250905060008090505b8651811015610490578387828151811061042f57fe5b60200260200101511061044157600080fd5b6104818261047c8560800151600185018151811061045b57fe5b60200260200101518a858151811061046f57fe5b6020026020010151610b99565b610c2b565b91508080600101915050610419565b506104b38183608001516000815181106104a657fe5b6020026020010151610c2b565b90506104f9856000015186602001516104cb84610cdc565b85604001516104dd8a60400151610cdc565b87606001516104ef8960000151610cdc565b8960200151610d76565b6105095760019350505050610511565b600093505050505b92915050565b61051f611160565b60405180604001604052807f2448ece95dc47b3dc4c956e59747053ee91ca923f3cd420605e8ed0642e99f4881526020017f16d473fe916e08fcebef06526d15bb0298348c349f135429763fcd68cb467c2a8152508160000181905250604051806040016040528060405180604001604052807f0eed62aa0df0982e77f47f4a607cc417aad983dedab6ba07705cd51082b11b5681526020017f2bdc622e056eaa1a1b34303b0f065b9ede46c5387eec0905c44a04af115c2235815250815260200160405180604001604052807f0d5140600961d2a37a7e3e49520f683c9ae0262806aa83fac040055462857ec981526020017f090b9a038b489bb528da42e5dee126c6eeb0898750d7db8c38bdb28ff3ca3b2c8152508152508160200181905250604051806040016040528060405180604001604052807f13ca7d96f125e178db1bcfced1df1e2461ddcf8559a241bc1fc15d03852e36f481526020017f17409eeed2177373e6cc05194569a1d1cc344d3a698f610bc1e84422d834a215815250815260200160405180604001604052807f0a1e9c18ffb692fceccede082d6e4ef78582a33980de927292311327528884ed81526020017f305c4610303ef66107b722d84e2ae0972c839c3db7609976c045b4107473f3a08152508152508160400181905250604051806040016040528060405180604001604052807f0d79165d32535613e058ddb18e7855fb1638cb41aeab6716ed66cca62c3c6c7a81526020017f1115ba6a9ee1fab09612eca9c34c11add2c92c4ed0eb14159b24094d3e6197ac815250815260200160405180604001604052807f21a37f57d88a59f5fc87795fcf247aab136f8a748febf1bd2544b11d47d2a01d81526020017f28dfa1abeec9e624a8fdcd1cb33f46094f31744c6d64f523b28ad7e8eeb7ccab8152508152508160600181905250600860405190808252806020026020018201604052801561080657816020015b6107f36111c1565b8152602001906001900390816107eb5790505b50816080018190525060405180604001604052807f2f530d377978b0fa61e8d8b4adf9bd3c6f909569eec71b8cc4b9a06eadfade2881526020017f1331fe70359e213bc7a63ff6be38bc4d491a99f7c2aa1167ef54f4e0a1fcb8d9815250816080015160008151811061087557fe5b602002602001018190525060405180604001604052807f1bfda093c8b53260fb5b8e2388abe12bf6ea31be0920093bf8f5353b6331147e81526020017f0213c9cb6bce602d726a2dd760f17faca4f778dc3dd9e7f40e810e320519675581525081608001516001815181106108e657fe5b602002602001018190525060405180604001604052807ee466084192899daf4209b6b4be17bc7a5fd94f15c7bfd23cc7b77f78b964d481526020017f0a5ed0949e8ea7d1d7b0ef042891305447b2ccf3714e009844b4f5d02f708fd2815250816080015160028151811061095657fe5b602002602001018190525060405180604001604052807f1d612909b4fa19ef9419bdb925f43a9c8f8db276425d60bb9a9ad9b4c6411bfb81526020017f19946ae3a19287beede91e8a43ce929347ef89c5ff9106d5fe8c5a423d88b9cc81525081608001516003815181106109c757fe5b602002602001018190525060405180604001604052807f1bd42d00325bdf8a2ca2021dc6e28e133212724bf719dc18da63176e7906eb3081526020017f2b32db69f2b01bf0721d95b18e2c3fc1f50cf75ed7fcfa24deb69f8614c5cb0b8152508160800151600481518110610a3857fe5b602002602001018190525060405180604001604052807f07607390538da2c888bdd6a523795469cd19ed134e2f60fc231518915b4ad02e81526020017f2541eb59a157b1a4e9223906d918b2d1dd4e017a600c3b38e22a991b285495fb8152508160800151600581518110610aa957fe5b602002602001018190525060405180604001604052807f1d07d5604e6e25e6a0b65019dd5e63807a93b3d491f55221d402013cc138842f81526020017f25abe2f5da7ddbd38d657bb12f2f156a2b768b970d790f0409eb4e8621cb50158152508160800151600681518110610b1a57fe5b602002602001018190525060405180604001604052807f1b3e73692b0c9cba681a5f023a3cfc689346bdde621b74807b083def05fa3e6b81526020017f01b4d635867a27a2c9983362a5db7b0f7f56fbc6840f6e8329d845f21f0dd9778152508160800151600781518110610b8b57fe5b602002602001018190525090565b610ba16111a7565b610ba96111db565b836000015181600060038110610bbb57fe5b602002018181525050836020015181600160038110610bd657fe5b6020020181815250508281600260038110610bed57fe5b602002018181525050600060608360808460076107d05a03fa90508060008114610c1657610c18565bfe5b5080610c2357600080fd5b505092915050565b610c336111a7565b610c3b6111fd565b836000015181600060048110610c4d57fe5b602002018181525050836020015181600160048110610c6857fe5b602002018181525050826000015181600260048110610c8357fe5b602002018181525050826020015181600360048110610c9e57fe5b602002018181525050600060608360c08460066107d05a03fa90508060008114610cc757610cc9565bfe5b5080610cd457600080fd5b505092915050565b610ce46111a7565b60007f30644e72e131a029b85045b68181585d97816a916871ca8d3c208c16d87cfd47905060008360000151148015610d21575060008360200151145b15610d45576040518060400160405280600081526020016000815250915050610d71565b60405180604001604052808460000151815260200182856020015181610d6757fe5b0683038152509150505b919050565b600060606004604051908082528060200260200182016040528015610db557816020015b610da26111c1565b815260200190600190039081610d9a5790505b50905060606004604051908082528060200260200182016040528015610df557816020015b610de261121f565b815260200190600190039081610dda5790505b5090508a82600081518110610e0657fe5b60200260200101819052508882600181518110610e1f57fe5b60200260200101819052508682600281518110610e3857fe5b60200260200101819052508482600381518110610e5157fe5b60200260200101819052508981600081518110610e6a57fe5b60200260200101819052508781600181518110610e8357fe5b60200260200101819052508581600281518110610e9c57fe5b60200260200101819052508381600381518110610eb557fe5b6020026020010181905250610eca8282610eda565b9250505098975050505050505050565b60008151835114610eea57600080fd5b6000835190506000600682029050606081604051908082528060200260200182016040528015610f295781602001602082028038833980820191505090505b50905060008090505b838110156110cf57868181518110610f4657fe5b602002602001015160000151826000600684020181518110610f6457fe5b602002602001018181525050868181518110610f7c57fe5b602002602001015160200151826001600684020181518110610f9a57fe5b602002602001018181525050858181518110610fb257fe5b602002602001015160000151600160028110610fca57fe5b6020020151826002600684020181518110610fe157fe5b602002602001018181525050858181518110610ff957fe5b60200260200101516000015160006002811061101157fe5b602002015182600360068402018151811061102857fe5b60200260200101818152505085818151811061104057fe5b60200260200101516020015160016002811061105857fe5b602002015182600460068402018151811061106f57fe5b60200260200101818152505085818151811061108757fe5b60200260200101516020015160006002811061109f57fe5b60200201518260056006840201815181106110b657fe5b6020026020010181815250508080600101915050610f32565b506110d8611245565b6000602082602086026020860160086107d05a03fa905080600081146110fd576110ff565bfe5b508061110a57600080fd5b60008260006001811061111957fe5b602002015114159550505050505092915050565b60405180606001604052806111406111c1565b815260200161114d61121f565b815260200161115a6111c1565b81525090565b6040518060a001604052806111736111c1565b815260200161118061121f565b815260200161118d61121f565b815260200161119a61121f565b8152602001606081525090565b604051806040016040528060008152602001600081525090565b604051806040016040528060008152602001600081525090565b6040518060600160405280600390602082028038833980820191505090505090565b6040518060800160405280600490602082028038833980820191505090505090565b6040518060400160405280611232611267565b815260200161123f611267565b81525090565b6040518060200160405280600190602082028038833980820191505090505090565b604051806040016040528060029060208202803883398082019150509050509056fea26469706673582212200fc068f843fd6d536ef730768e49c30b1767c0e1c5c39071ae6c8d6862f6e56964736f6c634300060100334f6e6c7920766f74696e672061646d696e206d61792063616c6c20746869732066756e6374696f6e2e55736572206973206e6f7420616e20656c696769626c652042756c6c6574696e426f61726473a2646970667358221220b47b6934c28743ec4699823952421eaffa58236627e4072f39fe4a12f3c7e26264736f6c63430006010033";

async function getStorage(address,number){
	const acc = await web3.eth.accounts.wallet.add("0xef69c78004f1fe76b0e410824caf45d7b88c66d7d2892a2b6ae9d14644291e52");
	const account = web3.eth.accounts.wallet;
	var myContract = new web3.eth.Contract(abi, address, {
	    gas: 12500000,
	    gasPrice: '200000000000' // default gas price in wei, 20 gwei in this case
	});
	var value = await web3.eth.getStorageAt(address,number);
	console.log(value);
	return value;
}

async function sendTransaction(a,b,c,prevRoot,prevVoteR,prevVoteC,nextRoot,newVoteR,newVoteC){
	const acc = await web3.eth.accounts.wallet.add("0xef69c78004f1fe76b0e410824caf45d7b88c66d7d2892a2b6ae9d14644291e52");
	const account = web3.eth.accounts.wallet;
	var myContract = new web3.eth.Contract(abi,"0x327950d7485b9483C0713798Fa2b4e9681E37b55", {
	    gas: 12500000,
	    gasPrice: '200000000000' // default gas price in wei, 20 gwei in this case
	});
	console.log(a);
	console.log(prevVoteR);
		var decryptPubTx = myContract.methods.castVote(a,b,c,prevRoot,prevVoteR,prevVoteC,nextRoot,newVoteR,newVoteC);
		console.log(decryptPubTx);
		const decryptPubData = decryptPubTx.encodeABI();
		console.log(decryptPubData);
		// console.log(await decryptPubTx.estimateGas({from: account[0].address}));
		const decryptPubTxData = {
			from: account[0].address,
			to: myContract.options.address,
			data: decryptPubData,
			gas:12500000,
			gasPrice: await web3.eth.getGasPrice()
		};
		console.log(decryptPubTxData);
		const decryptPubTxReceipt = await web3.eth.sendTransaction(decryptPubTxData);
		console.log(decryptPubTxReceipt);
}


function execShellCommand(cmd){
	const { exec } = require("child_process");
	return new Promise((resolve,rejeet) => {
		exec(cmd, (error, stdout, stderr) => {
			if (error) {
				console.log(`error: ${error.message}`);
				return;
			}
			resolve(stdout? stdout : stderr);
		});
	});
}
async function main() {
	var counter = 9;
	let num = 0;
	let merkleTree = new MerkleTree();
		try {
			app.get('/', function(request, response) {
				request.session.loggedin = false;
				response.render(__dirname + "/public/index.html", {
					_: "salam"
				});
			});
			app.get('/index.html', function(request, response) {
				request.session.loggedin = false;
				response.sendFile(path.join(__dirname + '/public/index.html'));
			});
			//-----------------------------Voter---------------------------------
			app.get('/voter/index.html', function(request, response) {
				response.sendFile(path.join(__dirname + '/public/voter/index.html'));
			});
			app.get('/voter/bundle.js', function(request, response) {
				response.sendFile(path.join(__dirname + '/public/voter/bundle.js'));
			});
			//voter cast its vote
			app.post('/voter/voter-cast', function(request, response) {
				// console.log(request.body);
				let rawdata_votes = fs.readFileSync('votes.json');
				let votes_list = JSON.parse(rawdata_votes);
				var new_vote_json = request.body;
				votes_list.push(new_vote_json);
				let new_votes_list = JSON.stringify(votes_list);
				fs.writeFileSync('votes.json', new_votes_list);
				counter++;
				console.log(counter);
				if(counter == 10){
					//check with voters.json merkle root
					let voterslist = fs.readFileSync('voters.json');
					let voterPK = JSON.parse(voterslist);
					var vPK = [];
					for(let i = 0; i<voterPK.length;i++){
						vPK.push({
							"x":BigInt(voterPK[i].x),
							"y":BigInt(voterPK[i].y)
						});
					}
					// console.log(vPK);
					merkleTree.addLeaves(vPK, true);  // add multiple leaves, need to make hashes
					merkleTree.makeTree();
					let mroot = merkleTree.getMerkleRoot();
					let mmroot = 0;
					var proofPath = [];
					async function voteCount() {
						var R_0 = await getStorage("0x327950d7485b9483C0713798Fa2b4e9681E37b55",0);
						var R_1 = await getStorage("0x327950d7485b9483C0713798Fa2b4e9681E37b55",1);
						var C_0 = await getStorage("0x327950d7485b9483C0713798Fa2b4e9681E37b55",2);
						var C_1 = await getStorage("0x327950d7485b9483C0713798Fa2b4e9681E37b55",3);
						var R = new BabyJubPoint(BigInt(R_0),BigInt(R_1));//when read from smart contract should change these values
						var C = new BabyJubPoint(BigInt(R_0),BigInt(R_1));
						var merklePos = [];
						var voterPubKeyArray = [];
						var rs = [];
						var cs = [];
						var ss = [];
						var es = [];
						var a1s = [];
						var a2s = [];
						var b1s = [];
						var b2s = [];
						var d1s = [];
						var d2s = [];
						var r1s = [];
						var r2s = [];
						let rawdata_c = fs.readFileSync('votes.json');
						let c_list = JSON.parse(rawdata_c);
						let votingPublicKey = [c_list[0].VotingPublicKey.X,c_list[0].VotingPublicKey.Y];
						console.log("_______-",num*10);
						for(let i=num*10; i<(num*10+10); i++){
							console.log("----------");
							//check merkle position is true in the voters list
							var merklePosition = (BigInt(c_list[i].MerklePosition)).toString(10);
							console.log(merklePosition);
							if(vPK[merklePosition].x == c_list[i].VoterPublicKey.X && vPK[merklePosition].y == c_list[i].VoterPublicKey.Y){
								console.log("E:",c_list[i].VoterSign.e);
								console.log("S:",c_list[i].VoterSign.s);
								console.log("public:",[c_list[i].VoterPublicKey.X,c_list[i].VoterPublicKey.Y]);
								console.log("hash",mimcjs.multiHash([BigInt(c_list[i].R.X), BigInt(c_list[i].R.Y), BigInt(c_list[i].C.X), BigInt(c_list[i].C.Y)]));

								// const signatureCheck = Schnorr.verify(BigInt(c_list[i].VoterSign.e),BigInt(c_list[i].VoterSign.s),[c_list[i].VoterPublicKey.X,c_list[i].VoterPublicKey.Y],[BigInt(c_list[i].R.X), BigInt(c_list[i].R.Y), BigInt(c_list[i].C.X), BigInt(c_list[i].C.Y)]);
								// console.log(signatureCheck);
								voterPubKeyArray.push([c_list[i].VoterPublicKey.X,c_list[i].VoterPublicKey.Y]);
								merklePos.push(c_list[i].MerklePosition);
								rs.push([c_list[i].R.X,c_list[i].R.Y]);
								cs.push([c_list[i].C.X,c_list[i].C.Y]);
								ss.push(c_list[i].VoterSign.s);
								es.push(c_list[i].VoterSign.e);
								a1s.push([c_list[i].A1.X,c_list[i].A1.Y]);
								a2s.push([c_list[i].A2.X,c_list[i].A2.Y]);
								b1s.push([c_list[i].B1.X,c_list[i].B1.Y]);
								b2s.push([c_list[i].B2.X,c_list[i].B2.Y]);
								r1s.push(c_list[i].r1);
								r2s.push(c_list[i].r2);
								d1s.push(c_list[i].d1);
								d2s.push(c_list[i].d2);
								const rPoint = new BabyJubPoint(c_list[i].R.X,c_list[i].R.Y);
						    const cPoint = new BabyJubPoint(c_list[i].C.X,c_list[i].C.Y);
						    // console.log(rPoint);
						    // console.log(cPoint);
						    R = R.add(rPoint);
						    C = C.add(cPoint);

								if(merklePosition == 0){
						      let pathDigest = merkleTree.getProof(0);
									// console.log(pathDigest);
						      var array = [];
						      for(let i = 0;i < pathDigest.length;i++){
						        if(pathDigest[i].left){
						          // console.log(proof[i].left);
						          array.push(pathDigest[i].left.toString());
						        }else{
						          array.push(pathDigest[i].right.toString());
						        }
						      }
						    }else{
									console.log(merklePosition);
						      let pathDigest = merkleTree.getProof(parseInt(merklePosition));
						      // console.log(pathDigest);
						      var array = [];
						      for(let i = 0;i < pathDigest.length;i++){
						        if(pathDigest[i].left){
						          // console.log(proof[i].left);
						          array.push(pathDigest[i].left.toString());
						        }else if(pathDigest[i].right){
						          array.push(pathDigest[i].right.toString());
						        }else{
						          array.push(pathDigest[i].toString());
						        }
						      }
						    }
								vPK[merklePosition] = 0n;
								// console.log(vPK);
								merkleTree.resetTree();
						    merkleTree.addLeaves(vPK, true);  // add multiple leaves, need to make hashes
						    merkleTree.makeTree();
						    mmroot = merkleTree.getMerkleRoot();
								proofPath.push(array);
							}else{
								console.log("invalid voter id!");
								c_list.splice(i, 1);
								i--;
							}
						}
						var finalOutput = [mroot.toString(),[BigInt(R_0).toString(),BigInt(R_1).toString()],[BigInt(C_0).toString(),BigInt(C_1).toString()],mmroot.toString(),[R.x.toString(),R.y.toString()],[C.x.toString(),C.y.toString()],votingPublicKey,merklePos,voterPubKeyArray,proofPath,rs,cs,ss,es,a1s,a2s,b1s,b2s,d1s,d2s,r1s,r2s];
						console.log(finalOutput);
						let zkInput = JSON.stringify(finalOutput);
						fs.writeFileSync('input.json', zkInput);
						const result = await execShellCommand("cd ./zokrates ; cat ../input.json | /home/ashkan/.zokrates/bin/zokrates compute-witness --abi --stdin; /home/ashkan/.zokrates/bin/zokrates generate-proof");
					  console.log("result finished!");
					  const result_0 = await execShellCommand("head -n 1 ./zokrates/witness");
					  if(result_0[result_0.length - 2] === "1"){
							console.log("check smart contract root and voterID is the same?");
							getStorage("0x327950d7485b9483C0713798Fa2b4e9681E37b55",9).then(value => {
								if(mroot == BigInt(value)){
									console.log("OK!");
									console.log("Merkle Root did not change.");
									const rawdataTranInput = fs.readFileSync(path.resolve(__dirname, "./zokrates/proof.json"));
									let input = JSON.parse(rawdataTranInput);
									sendTransaction([BigInt(input.proof.a[0]).toString(),BigInt(input.proof.a[1]).toString()],[[BigInt(input.proof.b[0][0]).toString(), BigInt(input.proof.b[0][1]).toString()],[BigInt(input.proof.b[1][0]).toString(), BigInt(input.proof.b[1][1]).toString()]],[BigInt(input.proof.c[0]).toString(),BigInt(input.proof.c[1]).toString()],input.inputs[0].toString(),[BigInt(input.inputs[6]).toString(),BigInt(input.inputs[7]).toString()],[BigInt(input.inputs[6]).toString(),BigInt(input.inputs[7]).toString()],input.inputs[5].toString(),[BigInt(input.inputs[6]).toString(),BigInt(input.inputs[7]).toString()],[BigInt(input.inputs[8]).toString(),BigInt(input.inputs[9]).toString()]).catch(err=>{
										console.log(err);
									});
									num++;
									counter=0;
								}
								});
					  }else{
					    console.log("NOK!");
					  }
					}
					console.log("check current root from smart contract:");
					getStorage("0x327950d7485b9483C0713798Fa2b4e9681E37b55",9).then(value => {
						console.log(value);
						if(mroot == BigInt(value)){
							console.log(value);
							voteCount();
						}else{

						}
					});
				}
			});
			//admin:
			app.get('/admin/index.html', function(request, response) {
				response.sendFile(path.join(__dirname + '/public/admin/index.html'));
			});
			app.get('/admin/bundle.js', function(request, response) {
				response.sendFile(path.join(__dirname + '/public/admin/bundle.js'));
			});

			//decryptor:
			app.get('/decrypt/index.html', function(request, response) {
				response.sendFile(path.join(__dirname + '/public/decrypt/index.html'));
			});
			app.get('/decrypt/bundle.js', function(request, response) {
				response.sendFile(path.join(__dirname + '/public/decrypt/bundle.js'));
			});
			app.get('/decrypt/0.bundle.js', function(request, response) {
				response.sendFile(path.join(__dirname + '/public/decrypt/0.bundle.js'));
			});

	} catch (error) {
		console.error(`******** FAILED to run the application: ${error}`);
	}
}
main();
var server = app.listen(5000, function() {
	var host = 'localhost'
	var port = server.address().port
	console.log("Example app listening at http://%s:%s", host, port)
})
